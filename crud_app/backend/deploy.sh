#!/bin/bash

# Script de dÃ©ploiement pour le backend CRUD avec variables d'environnement
# Usage: ./deploy.sh [environment] [version]

set -e

# Variables par dÃ©faut
ENVIRONMENT=${1:-"production"}
VERSION=${2:-"$(date +%Y%m%d-%H%M%S)"}
INSTANCE_ID=${INSTANCE_ID:-"$(hostname)"}
DEPLOYMENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

echo "=========================================="
echo "ğŸš€ DÃ©ploiement du Backend CRUD"
echo "=========================================="
echo "ğŸ“± Environnement: $ENVIRONMENT"
echo "ğŸ“¦ Version: $VERSION"
echo "ğŸ†” Instance: $INSTANCE_ID"
echo "ğŸ“… Date: $DEPLOYMENT_DATE"
echo "=========================================="

# Fonction pour exporter les variables d'environnement
setup_environment() {
    echo "ğŸ“ Configuration des variables d'environnement..."
    
    # Variables de base
    export NODE_ENV="$ENVIRONMENT"
    export DEPLOYMENT_VERSION="$VERSION"
    export DEPLOYMENT_DATE="$DEPLOYMENT_DATE"
    export INSTANCE_ID="$INSTANCE_ID"
    export ENVIRONMENT="$ENVIRONMENT"
    
    # Variables spÃ©cifiques Ã  l'environnement
    case $ENVIRONMENT in
        "production")
            export PORT=${PORT:-3001}
            export HOST=${HOST:-"0.0.0.0"}
            export LOG_LEVEL=${LOG_LEVEL:-"warn"}
            export ENABLE_CORS=${ENABLE_CORS:-"true"}
            export CORS_ORIGINS=${CORS_ORIGINS:-"*"}
            export DB_POOL_MAX=${DB_POOL_MAX:-20}
            export ENABLE_RATE_LIMIT=${ENABLE_RATE_LIMIT:-"true"}
            export RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
            ;;
        "staging")
            export PORT=${PORT:-3001}
            export HOST=${HOST:-"0.0.0.0"}
            export LOG_LEVEL=${LOG_LEVEL:-"info"}
            export ENABLE_CORS=${ENABLE_CORS:-"true"}
            export DB_POOL_MAX=${DB_POOL_MAX:-10}
            ;;
        "development")
            export PORT=${PORT:-3001}
            export HOST=${HOST:-"localhost"}
            export LOG_LEVEL=${LOG_LEVEL:-"debug"}
            export ENABLE_CORS=${ENABLE_CORS:-"true"}
            export CORS_ORIGINS=${CORS_ORIGINS:-"*"}
            export DB_POOL_MAX=${DB_POOL_MAX:-5}
            ;;
        *)
            echo "âŒ Environnement non supportÃ©: $ENVIRONMENT"
            exit 1
            ;;
    esac
    
    echo "âœ… Variables d'environnement configurÃ©es"
}

# Fonction pour installer les dÃ©pendances
install_dependencies() {
    echo "ğŸ“¦ Installation des dÃ©pendances..."
    npm ci --only=production
    echo "âœ… DÃ©pendances installÃ©es"
}

# Fonction pour valider la configuration
validate_config() {
    echo "ğŸ” Validation de la configuration..."
    
    if [ -z "$DATABASE_URL" ]; then
        echo "âŒ DATABASE_URL est requis"
        exit 1
    fi
    
    echo "âœ… Configuration validÃ©e"
}

# Fonction pour tester la connexion Ã  la base de donnÃ©es
test_database() {
    echo "ğŸ—„ï¸  Test de connexion Ã  la base de donnÃ©es..."
    
    # CrÃ©er un script de test temporaire
    cat > test_db.js << 'EOF'
const { config, validateConfig } = require('./config');
const { testConnection } = require('./database');

async function test() {
    try {
        validateConfig();
        const result = await testConnection();
        if (result.success) {
            console.log('âœ… Connexion Ã  la base de donnÃ©es rÃ©ussie');
            process.exit(0);
        } else {
            console.error('âŒ Ã‰chec de la connexion:', result.error);
            process.exit(1);
        }
    } catch (error) {
        console.error('âŒ Erreur de test:', error.message);
        process.exit(1);
    }
}

test();
EOF
    
    node test_db.js
    rm test_db.js
    
    echo "âœ… Base de donnÃ©es accessible"
}

# Fonction pour dÃ©marrer l'application
start_application() {
    echo "ğŸš€ DÃ©marrage de l'application..."
    
    if [ "$ENVIRONMENT" = "production" ]; then
        # En production, utiliser PM2 ou un process manager
        if command -v pm2 &> /dev/null; then
            pm2 start index.js --name "crud-backend-$VERSION" --env $ENVIRONMENT
        else
            # Fallback vers node en mode production
            NODE_ENV=$ENVIRONMENT node index.js
        fi
    else
        # En dÃ©veloppement/staging
        npm start
    fi
}

# Fonction pour crÃ©er un fichier .env avec les variables actuelles
create_env_file() {
    echo "ğŸ“ CrÃ©ation du fichier .env..."
    
    cat > .env << EOF
# Generated by deploy.sh on $DEPLOYMENT_DATE
NODE_ENV=$NODE_ENV
PORT=$PORT
HOST=$HOST
DATABASE_URL=$DATABASE_URL
LOG_LEVEL=$LOG_LEVEL
ENABLE_CORS=$ENABLE_CORS
CORS_ORIGINS=$CORS_ORIGINS
DB_POOL_MAX=$DB_POOL_MAX
DEPLOYMENT_VERSION=$DEPLOYMENT_VERSION
DEPLOYMENT_DATE=$DEPLOYMENT_DATE
INSTANCE_ID=$INSTANCE_ID
ENVIRONMENT=$ENVIRONMENT
EOF
    
    echo "âœ… Fichier .env crÃ©Ã©"
}

# Fonction principale
main() {
    echo "ğŸ DÃ©but du dÃ©ploiement..."
    
    setup_environment
    validate_config
    install_dependencies
    create_env_file
    test_database
    
    echo "=========================================="
    echo "âœ… DÃ©ploiement prÃªt!"
    echo "=========================================="
    echo "Pour dÃ©marrer l'application:"
    echo "  npm start"
    echo ""
    echo "Ou pour dÃ©marrer avec les variables d'environnement:"
    echo "  NODE_ENV=$ENVIRONMENT DEPLOYMENT_VERSION=$VERSION node index.js"
    echo "=========================================="
}

# VÃ©rifier si le script est appelÃ© directement
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi